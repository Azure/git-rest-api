# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.

trigger:
  - master

pr: none

stages:
#   - stage: Build_Docker
#     jobs:
#       - job: Build_Docker
#         pool:
#           vmImage: "Ubuntu-16.04"
#         steps:
#           - task: Docker@2
#             displayName: "Build azuredevx/git-rest-api"
#             inputs:
#               containerRegistry: "git-rest-api docker"
#               repository: "azuredevx/git-rest-api"
#               tags: |
#                 $(Build.BuildId)
#                 latest
#   - stage: Publish_Docker
#     dependsOn: Build_Docker
#     jobs:
#       - job: Publish_Docker
#         pool:
#           vmImage: "Ubuntu-16.04"
#         steps:
#           - task: Docker@2
#             displayName: "Push azuredevx/git-rest-api"
#             inputs:
#               containerRegistry: "git-rest-api docker"
#               repository: "azuredevx/git-rest-api"

  - stage: build_sdks
    displayName: Build SDKs
    dependsOn: []
    jobs:
      - job: build
        pool:
          vmImage: "Ubuntu-16.04"
        steps:
          - script: npm -s ci
          - script: npm -s run sdk:gen
          - script: npm -s pack
          - task: CopyFiles@2
            displayName: 'Copy Files to: drop'
            inputs:
              sourceFolder: ./sdk/out/typescript
              contents: '*.tgz'
              targetFolder: drop
          - task: PublishPipelineArtifact@0
            inputs:
              pathtoPublish: $(Build.SourcesDirectory)/drop
              
  - stage: publish_sdks
    displayName: Publish SDKs
    dependsOn: build_sdks
    jobs:
      - job: publish
        pool:
          vmImage: "Ubuntu-16.04"
        steps:
          - task: DownloadPipelineArtifact@0
            inputs:
              artifactName: 'drop'
              targetPath: $(agent.tempdirectory)
          - script: echo "Dir $(agent.tempdirectory)"
            workingDirectory: $(agent.tempdirectory)
          - script: ls
            workingDirectory: $(agent.tempdirectory)
          - task: NodeTool@0
            displayName: 'Use Node 10.x'
            inputs:
              versionSpec: 10.x
          - script: git clone https://github.com/ts-common/publish
            workingDirectory: $(agent.tempdirectory)
          - task: Npm@1
            displayName: 'npm run publishall'
            inputs:
              command: custom
              workingDir: $(agent.tempdirectory)/publish/
              verbose: false
              customCommand: 'run publishall'
              customEndpoint: 'azure-sdk NPM'