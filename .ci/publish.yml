# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.

trigger:
  - master

pr: none

stages:
  - stage: Build_Docker
    jobs:
      - job: Build_Docker
        pool:
          vmImage: "Ubuntu-16.04"
        steps:
          - task: Docker@2
            displayName: "Build azuredevx/git-rest-api"
            inputs:
              containerRegistry: "git-rest-api docker"
              repository: "azuredevx/git-rest-api"
              tags: |
                $(Build.BuildId)
                latest
  - stage: Publish_Docker
    dependsOn: Build_Docker
    jobs:
      - job: Publish_Docker
        pool:
          vmImage: "Ubuntu-16.04"
        steps:
          - task: Docker@2
            displayName: "Push azuredevx/git-rest-api"
            inputs:
              containerRegistry: "git-rest-api docker"
              repository: "azuredevx/git-rest-api"

  - stage: build_sdks
    displayName: Build SDKs
    dependsOn: []
    jobs:
      - job: build
        pool:
          vmImage: "Ubuntu-16.04"
        steps:
          - script: npm -s ci
          - script: npm -s run sdk:gen
          - task: Npm@1
            displayName: 'npm run publish'
            inputs:
              command: publish
              workingDir: sdk/out/typescript
              verbose: false
              publishEndpoint: 'azure-sdk NPM'
